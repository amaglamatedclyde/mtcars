---
title: "An Analysis of Fuel Efficiency"
author: "Clyde Tressler"
date: "December 18, 2015"
output: pdf_document
---

##Executive Summary

MotorTrend magazine data from observations of 32 models of cars were analyzed to help understand the characteristics that account for fuel efficiency. Of particular interest is whether there is an effect associated with automatic versus manual transmission. After we account for the effect of a strong relationship between vehicle weight and transmission type, we can say that there is a statistically significant increase in gas mileage associated with manual transmissions, which we report as a mean increase of **9.23 mpg**, with a maximum **P-value of 0.00378**.

###Data Processing and Initial Exploratory Analyses
This report omits some code for brevity. The entire R markdown file can be found [here](https://github.com/amaglamatedclyde/mtcars).

Here we show the first several rows of the dataset.

```{r, include=F}
library(knitr)
library(dplyr)
library(car)
data(mtcars)
attach(mtcars)
```

```{r, message=FALSE, echo=FALSE}
head(mtcars, 3)
```

In the Appendix we present a table explaining the meaning of variable names. Several binary and discrete variables were transformed from numeric vectors to factor variables for this analysis.

```{r, include=FALSE}
mtcars$am <- as.factor(mtcars$am)
mtcars$cyl <- as.factor(mtcars$cyl)
mtcars$gear <- as.factor(mtcars$gear)
mtcars$vs <- as.factor(mtcars$vs)
mtcars$carb <- as.factor(mtcars$carb)
```

Also in the Appendix we present a box and whisker plot of the two transmission types demonstrating that the median mpg of the automatic group lies below that of the manual group. We use hypothesis testing to determine if the difference in the means is statistically significant. 

```{r, include=F}

am1 <- subset(mtcars, am==1)
am0 <- subset(mtcars, am==0)
t.test(am1$mpg, am0$mpg)
```

```{r, include=F}
diff.means <- round(mean(am1$mpg)-mean(am0$mpg), 2)
```

We report a p-value for a t-test with unequal variances as 0.001374 and therefor reject the null hypothesis at the 95% confidence level, to conclude that the difference between the means, `r diff.means` mpg, is significant. 

###Developing a Multivariate Linear Model
Next we turn to multivariate regression to develop a model that will help us understand whether confounding variables are contributing **[omitted variable bias](https://en.wikipedia.org/wiki/Omitted-variable_bias)**. We tabulate the correlation of the numeric variables, as many of them measure closely-related properties. 

<div align="center">**Correlation Table of mtcars Data**</div>
```{r, echo=FALSE, fig.align="top", fig.height=2}
kable(cor(mtcars[sapply(mtcars, class)=="numeric"]))
```

We now consider the apriori exclusion of certain variables. First, the quarter second mile time is influenced by driver skill and is heavily biased in favor of manual transmission, but adds little meaning to ordinary driving conditions, so we choose not to include it. 

We also know that 'drat,' the rear axle ratio, is a downstream variable determined by the upstream drive train, including the transmission, so we choose not to include it when analyzing fuel efficiency.

From the correlation table we select weight as our first predictor, since it is the variable most highly correlated with mpg. 

Looking at the data sorted by weight below, we see that 9 of the top 10 heaviest cars have automatic transmissions, while 9 of lightest 10 have manual. This leads us to the addition of an interaction term between weight and transmission type to the model. In the Appendix we show a visualization of this relationship.

<div align="center">**Sorting the Data by Vehicle Weight**</div>
```{r Sorting By Weight, echo=F}
kable(mtcars %>% add_rownames(var="rownames") %>% select(rownames, wt, am, hp, mpg) %>% arrange(-wt) %>% head(10))
kable(mtcars %>% add_rownames(var="rownames") %>% select(rownames, wt, am, hp, mpg) %>% arrange(-wt) %>% tail(10))
```

We systematically examine the inclusion of other variables while seeking to maintain significant P-values for their coefficients and maximize the fit as measured by R-squared. We choose to include horsepower, which will therefor serve as a proxy for the remaining collinear engine performance variables and refer the reader to the full R markdown file for the code.

```{r, echo=F, message=F, include=F}
model2 <- lm(mpg~wt+am+cyl, mtcars)
model3 <- lm(mpg~wt+am+disp, mtcars)
model4 <- lm(mpg~wt+am+hp, mtcars)
# summary(model4)
model5 <- lm(mpg~wt+am+vs, mtcars)
model6 <- lm(mpg~wt+am+gear, mtcars)
model7 <- lm(mpg~wt+am+carb, mtcars)
# lapply(list(model2, model3, model4, model5, model6, model7), function(m) summary(m))
lapply(list(model4, model5), function(m) summary(m)$coef)
```

####Diagnostics

Now we use ANOVA testing of nested models to choose which terms to include in our selection.

```{r, echo=F, message=F}
fit <- lm(mpg~wt, mtcars)
fit2 <- update(fit, mpg~wt+hp)
fit3 <- update(fit, mpg~wt+hp+am)
fit4 <- update(fit, mpg~wt+hp+am+wt*am)
fit5 <- update(fit, mpg~wt+hp+am+wt*am+hp*am)
anova(fit,fit2,fit3,fit4,fit5)

```
Once we satisfy the required inclusion of transmission type, we see that the addition of the interaction term (wt*am) is necessary. 

In the Appendix we plot residuals vs hat-values for the model **mpg~wt+hp+am+wt\*am** and identify the Maserati Bora as a high influence point. This is a high-performance vehicle and is the only vehicle in the data set with 8 carburetors. Furthermore, the dfbeta of this point for the coefficient of transmission type, -2.2929, lends motivation to our choice to remove it.

Now we note that the response for mpg vs horsepower (see Appendix) looks a bit quadratic but the removal of the Maserati data point has lessens this effect.

The residuals vs Fit and Q-Q plots shown in the Appendix indicate that the residuals are close to normally-distributed, which is further supported by the R-squared value of the model.
 
```{r, echo=F, message=F}
mtcars2 <- mtcars[-31,]
candidate.model <- lm(mpg~wt+hp+am+wt*am, mtcars2)

hp.squared <- lm(mpg~wt+hp+am+wt*am+I(hp*hp), mtcars2)
summary(candidate.model)
confint(candidate.model)
# summary(hp.squared)
```


###Conclusion
We have shown that a linear model using weight, horsepower, transmission type, and an interaction term between weight and transmission fits observations in the data set well, with an R-squared value of 0.868, indicating 86.8% of the total variance in mpg has been explained. The 95% confidence intervals for the coefficients show no instances where the intervals cross zero and the residuals plots show no discernible patterns. The Q-Q plot supports the assertion that the residual

Clearly fuel efficiency is adversely impacted by weight, as shown by the negative slope in the linear model. Likewise, increases in horsepower, which we take to be a proxy for other engine size variables such as displacement and numbers of cylinders, also reduce fuel efficiency.

We can report that the mean increase in miles per gallon associated with a manual transmission, as calculated from the values of the transmission type coefficient and its interaction term with weight,is shown to be 9.23 mpg, with a maximum P-value of 0.00378 as given by the interaction term.

##Appendix

###[Table 1: Variables](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/mtcars.html)
Variable Name | Description
------------- | -------------
mpg|Miles/(US) gallon
cyl|Number of cylinders
disp|Displacement (cu.in.)
hp|Gross horsepower
drat|Rear axle ratio
wt|Weight(lb/1000)
qsec|1/4 mile time
vs|Cylinder alignment, V or Straight
am|Transmission (0 = automatic, 1 = manual)
gear|Number of forward gears
carb|Number of carburetors

<div align="center">
##Box and Whisker plot of MPG vs Transmission Type

```{r, echo=F, fig.width=6,fig.height=6, fig.align='center'}
plot(mtcars$am, mtcars$mpg, col="steelblue", xaxt = "n", main="MPG vs Transmission Type", ylab="MPG")
axis(1, at=1:2, labels=c("Automatic", "Manual"))
```

##Interactions for Weight and Transmission and for Horsepower and Transmission
```{r, echo=F, message=F}
library(lattice)
require(gridExtra)
par(mfrow=c(1,2))
plot(mtcars$am, mtcars$wt, col="steelblue", xaxt = "n", main="Weight vs Transmission Type", ylab="Weight in 1/1000lb")
axis(1, at=1:2, labels=c("Automatic", "Manual"))
plot(mtcars$am, mtcars$hp, col="firebrick", xaxt = "n", main="Horsepower vs Trans. Type", ylab="Horsepower")
axis(1, at=1:2, labels=c("Automatic", "Manual"))
plot1 <- xyplot(mpg~wt,data=mtcars,groups=factor(am,labels=c("A","M")),
       pch=20,auto.key=list(columns=2),type=c("p","g"), cex=2)
plot2 <- xyplot(mpg~hp,data=mtcars,groups=factor(am,labels=c("A","M")),
       pch=20,auto.key=list(columns=2),type=c("p","g"), cex=2)
grid.arrange(plot1,plot2, ncol=2)
```

##Checking for High Influence Points

```{r, echo=F, fig.height=8, fig.width=8}
plot(hatvalues(fit4), fit4$residuals, pch=19, col="firebrick", main = "HatValues vs Residuals")
text( hatvalues(fit4), fit4$residuals, rownames( mtcars ), pos= 3, col="steelblue")
```

##Quadratic Response of MPG with Horsepower
```{r, echo=F, message=F}
library(ggplot2)
g <- ggplot(mtcars2, aes(hp, mpg, color=1))
g <- g+geom_point()
g <- g + geom_smooth()
g
```

##Comparing models with and without Horsepwer Squared Term
```{r, echo=F, message=F, fig.height=8}
par(mfrow=c(2,2))
plot(candidate.model)
```

```{r, echo=F, message=F, fig.height=8}
par(mfrow=c(2,2))
plot(hp.squared)
```
</div>